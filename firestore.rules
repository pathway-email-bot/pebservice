rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // firstName (if present) must be a non-empty string â‰¤100 chars with no
    // angle brackets.  We accept any script/culture but block '<' and '>' at
    // the data layer so stored names can never contain HTML tags (XSS).
    // Defence-in-depth: the portal also HTML-escapes at render time.
    function isValidFirstName(data) {
      return !('firstName' in data)
             || (data.firstName is string
                 && data.firstName.size() >= 1
                 && data.firstName.size() <= 100
                 && !data.firstName.matches('.*[<>].*'));
    }
    // Only these fields may be written from the client SDK.
    // The backend uses Admin SDK (bypasses rules) for other writes.
    function onlyAllowedFields() {
      return request.resource.data.keys().hasOnly(
        ['firstName', 'activeScenarioId', 'activeAttemptId']
      );
    }

    match /users/{email} {
      allow read: if request.auth != null
                  && request.auth.token.email == email;

      allow create: if request.auth != null
                    && request.auth.token.email == email
                    && onlyAllowedFields()
                    && isValidFirstName(request.resource.data);

      allow update: if request.auth != null
                    && request.auth.token.email == email
                    && request.resource.data.diff(resource.data)
                         .affectedKeys()
                         .hasOnly(['firstName', 'activeScenarioId', 'activeAttemptId'])
                    && isValidFirstName(request.resource.data);
    }
    match /users/{email}/attempts/{attemptId} {
      allow read: if request.auth != null
                  && request.auth.token.email == email;

      // Create: portal sets scenarioId, status, startedAt
      allow create: if request.auth != null
                    && request.auth.token.email == email
                    && request.resource.data.keys().hasOnly(
                         ['scenarioId', 'status', 'startedAt']
                       );

      // Update: portal can only change status (e.g. 'abandoned').
      // Score, feedback, etc. are written by the backend via Admin SDK.
      allow update: if request.auth != null
                    && request.auth.token.email == email
                    && request.resource.data.diff(resource.data)
                         .affectedKeys()
                         .hasOnly(['status']);
    }
  }
}
